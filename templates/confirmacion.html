{% extends base_template %}
{% block titulo %}Pedido Confirmado{% endblock %}
{% block contenido %}
<div style="max-width: 800px; margin: auto; padding: 20px;">
    <div class="check" style="font-size: 100px; color: green;">âœ…</div>
    <h1 style="color: #2e7d32; margin-bottom: 10px;">Â¡Pedido recibido correctamente!</h1>
    {% if pedido_id %}
    <p style="font-size:1.2em;color:#b30000;font-weight:bold;">Tu nÃºmero de pedido es: #{{ pedido_id }}</p>
    {% endif %}
    <p>Gracias por tu compra, {{ nombre }}.</p>

    <div class="detalle" style="
        background: white;
        display: inline-block;
        text-align: left;
        margin-top: 30px;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        max-width: 600px;
        width: 100%;
    ">
        <p><strong>ğŸ“ DirecciÃ³n:</strong> {{ direccion }}</p>
        {% if colonia %}
        <p><strong>ğŸ˜ï¸ Colonia:</strong> {{ colonia }}</p>
        {% endif %}
        <p><strong>ğŸ“ TelÃ©fono:</strong> {{ telefono }}</p>
        {% if numero_cliente %}
        <p><strong>ğŸ‘¤ NÃºmero de cliente:</strong> {{ numero_cliente }}</p>
        {% endif %}
        {% if horario_entrega %}
        <p><strong>â° Horario de entrega:</strong> {{ horario_entrega }}</p>
        {% endif %}

        <p><strong>ğŸ’³ Forma de pago:</strong> {{ info_pago or pago }}</p>
        
        {% if pago == "Transferencia" %}
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196f3;">
            <strong>ğŸ¦ Datos para transferencia:</strong><br>
            <small>
                CLABE: <strong>012180001234567890</strong><br>
                Titular: <strong>Abarrotes Soto S.A. de C.V.</strong><br>
                Banco: <strong>BBVA Bancomer</strong>
            </small><br>
            <small style="color: #1976d2;">
                ğŸ“± EnvÃ­a tu comprobante al WhatsApp <strong>55 7525 1742</strong>
            </small>
        </div>
        {% endif %}
        
        <hr>
        <p><strong>ğŸ›’ Productos:</strong></p>
        <ul style="padding-left: 20px; margin-bottom: 15px;">
            {% for p in carrito %}
            <li style="margin-bottom: 6px;">
                {{ p['nombre'] }} Ã— {{ p['cantidad'] }} = ${{ "%.2f"|format(p['precio'] * p['cantidad']) }}
                {% if p.get('precio_original') and p['precio_original'] > p['precio'] %}
                    <span style="color: #4caf50;">(Ahorro ${{ "%.2f"|format((p['precio_original'] - p['precio']) * p['cantidad']) }})</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        <div class="total" style="font-weight: bold; color: #2e7d32; margin-top: 15px; font-size: 1.1em;">
            ğŸ’° Total: ${{ "%.2f"|format(total) }}
            {% if ahorro > 0 %}
             â€” ğŸ‰ Ahorro: ${{ "%.2f"|format(ahorro) }}
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <a href="/" onclick="limpiarPedido()" style="
            padding: 12px 24px;
            background-color: #2e7d32;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            text-decoration: none;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            display: inline-block;
        " onmouseover="this.style.backgroundColor='#1b5e20'"
        onmouseout="this.style.backgroundColor='#2e7d32'">
            ğŸ  Volver al catÃ¡logo
        </a>
    </div>

    <script>
    function limpiarPedido() {
        localStorage.removeItem('carrito');
        localStorage.removeItem('pedido_enviado');
    }
    </script>

</div>

<style>
@media (max-width: 600px) {
    .check {
        font-size: 60px !important;
    }
    .detalle {
        width: 90% !important;
        padding: 15px !important;
    }
    .total {
        font-size: 16px !important;
    }
    h1 {
        font-size: 20px !important;
    }
    a[href="/"] {
        width: 100%;
        display: block !important;
        text-align: center;
    }
}
</style>

<script>
    // Limpiar el carrito del localStorage y del flotante
    window.onload = function () {
        localStorage.removeItem('carrito');
        localStorage.setItem('pedido_enviado', '1');
        carrito = [];  // ğŸ‘ˆ fuerza la variable a estar vacÃ­a en memoria
        document.getElementById('carrito-contador')?.textContent = '0';
        document.getElementById('carrito-total')?.textContent = '0.00';
        document.getElementById('carrito')?.style?.display = 'none';
        mostrarToast("Pedido enviado correctamente");
    };

    function mostrarToast(mensaje, color = "#4CAF50", icono = "âœ…") {
        const toast = document.getElementById("toast");
        const msg = document.getElementById("toast-message");
        const iconElem = document.getElementById("toast-icon");
        const bar = document.getElementById("toast-progress");

        msg.textContent = mensaje;
        iconElem.textContent = icono;
        toast.style.backgroundColor = color;
        toast.style.display = "block";

        bar.style.transition = "none";
        bar.style.width = "100%";
        void bar.offsetWidth;
        bar.style.transition = "width 5s linear";
        bar.style.width = "0%";

        setTimeout(() => {
            toast.style.display = "none";
        }, 5000);
    }
</script>

<script>
// ğŸ›’ Cargar y limpiar carrito si se enviÃ³ un pedido
let carrito = (() => {
    const flag = localStorage.getItem('pedido_enviado');
    if (flag === '1') {
        localStorage.removeItem('carrito');
        localStorage.removeItem('pedido_enviado');
        return [];
    }
    return JSON.parse(localStorage.getItem('carrito')) || [];
})();

// ğŸ”„ Actualizar contador del carrito en el encabezado
function actualizarBotonCarrito() {
    let total = 0, cantidad = 0;
    carrito.forEach(p => {
        total += p.precio * p.cantidad;
        cantidad += p.cantidad;
    });
    const contador = document.getElementById('carrito-contador');
    const totalSpan = document.getElementById('carrito-total');
    if (contador) contador.textContent = cantidad;
    if (totalSpan) totalSpan.textContent = total.toFixed(2);
}

window.onload = actualizarBotonCarrito;
</script>

{% endblock %}
