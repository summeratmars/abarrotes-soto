{% extends base_template %}
{% block titulo %}Pedido Confirmado{% endblock %}
{% block contenido %}
<div style="max-width: 800px; margin: auto; padding: 20px;">
    <div class="check" style="font-size: 100px; color: green;">‚úÖ</div>
    <h1 style="color: #2e7d32; margin-bottom: 10px;">¬°Pedido recibido correctamente!</h1>
        <div id="confirmacion-data"
            data-has-carrito="{{ 1 if carrito else 0 }}"
            data-telefono="{{ telefono }}"
            data-mp-status="{{ mp_status or '' }}"
            data-mp-payment-id="{{ mp_payment_id or '' }}"></div>
    {% if pedido_id %}
    <p style="font-size:1.2em;color:#b30000;font-weight:bold;">Tu n√∫mero de pedido es: #{{ pedido_id }}</p>
    {% endif %}
    <p>Gracias por tu compra, {{ nombre }}.</p>

    <div class="detalle" style="
        background: white;
        display: inline-block;
        text-align: left;
        margin-top: 30px;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        max-width: 600px;
        width: 100%;
    ">
        <p><strong>üìç Direcci√≥n:</strong> {{ direccion }}</p>
        {% if colonia %}
        <p><strong>üèòÔ∏è Colonia:</strong> {{ colonia }}</p>
        {% endif %}
        <p><strong>üìû Tel√©fono:</strong> {{ telefono }}</p>
        {% if numero_cliente %}
        <p><strong>üë§ N√∫mero de cliente:</strong> {{ numero_cliente }}</p>
        {% endif %}
        {% if horario_entrega %}
        <p><strong>‚è∞ Horario de entrega:</strong> {{ horario_entrega }}</p>
        {% endif %}

        <p><strong>üí≥ Forma de pago:</strong> {{ info_pago or pago }}</p>
        
        {% if pago == "Transferencia" %}
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196f3;">
            <strong>üè¶ Datos para transferencia:</strong><br>
            <small>
                CLABE: <strong>012180001234567890</strong><br>
                Titular: <strong>Abarrotes Soto S.A. de C.V.</strong><br>
                Banco: <strong>BBVA Bancomer</strong>
            </small><br>
            <small style="color: #1976d2;">
                üì± Env√≠a tu comprobante al WhatsApp <strong>55 7525 1742</strong>
            </small>
        </div>
        {% endif %}
        
        <hr>
        <p><strong>üõí Productos:</strong></p>
        <ul style="padding-left: 20px; margin-bottom: 15px;">
            {% for p in carrito %}
            <li style="margin-bottom: 6px;">
                {{ p['nombre'] }} √ó {{ p['cantidad'] }} = ${{ "%.2f"|format(p['precio'] * p['cantidad']) }}
                {% if p.get('precio_original') and p['precio_original'] > p['precio'] %}
                    <span style="color: #4caf50;">(Ahorro ${{ "%.2f"|format((p['precio_original'] - p['precio']) * p['cantidad']) }})</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        <div class="total" style="font-weight: bold; color: #2e7d32; margin-top: 15px; font-size: 1.1em;">
            üí∞ Total: ${{ "%.2f"|format(total) }}
            {% if ahorro > 0 %}
             ‚Äî üéâ Ahorro: ${{ "%.2f"|format(ahorro) }}
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <a href="/" onclick="limpiarPedido()" style="
            padding: 12px 24px;
            background-color: #2e7d32;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            text-decoration: none;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            display: inline-block;
        " onmouseover="this.style.backgroundColor='#1b5e20'"
        onmouseout="this.style.backgroundColor='#2e7d32'">
            üè† Volver al cat√°logo
        </a>
    </div>

    <script>
    function limpiarPedido() {
        localStorage.removeItem('carrito');
        localStorage.removeItem('pedido_enviado');
        localStorage.removeItem('metodo_pago');
        localStorage.removeItem('horario_entrega');
        localStorage.removeItem('pago_efectivo_cambio');
        localStorage.removeItem('pago_efectivo_monto');
    }
    </script>

</div>

<style>
@media (max-width: 600px) {
    .check {
        font-size: 60px !important;
    }
    .detalle {
        width: 90% !important;
        padding: 15px !important;
    }
    .total {
        font-size: 16px !important;
    }
    h1 {
        font-size: 20px !important;
    }
    a[href="/"] {
        width: 100%;
        display: block !important;
        text-align: center;
    }
}
</style>

<script>
    // Recuperar datos si la sesi√≥n lleg√≥ vac√≠a (retorno de Mercado Pago)
    async function intentarRecuperacion() {
        const dataElem = document.getElementById('confirmacion-data');
        const hasCarrito = dataElem?.dataset?.hasCarrito === '1';
        if (hasCarrito) return false;

        const carritoLocal = JSON.parse(localStorage.getItem('carrito') || '[]');
        if (!carritoLocal.length) return false;

        const mpStatus = dataElem?.dataset?.mpStatus || '';
        const mpPaymentId = dataElem?.dataset?.mpPaymentId || '';

        let metodoPago = localStorage.getItem('metodo_pago') || '';
        if (!metodoPago && (mpStatus || mpPaymentId)) {
            metodoPago = 'Mercado Pago';
        }

        let infoPago = metodoPago;
        if (metodoPago === 'Mercado Pago') {
            if (mpStatus) {
                infoPago = mpStatus.toLowerCase() === 'approved'
                    ? 'Mercado Pago (pago en l√≠nea aprobado)'
                    : `Mercado Pago (estado: ${mpStatus})`;
            } else {
                infoPago = 'Mercado Pago (pago en l√≠nea)';
            }
        }

        const total = carritoLocal.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
        const ahorro = carritoLocal.reduce((sum, p) => {
            if (p.precio_original && p.precio_original > p.precio) {
                return sum + ((p.precio_original - p.precio) * p.cantidad);
            }
            return sum;
        }, 0);

        const payload = {
            nombre: localStorage.getItem('usuario_nombre') || '',
            telefono: localStorage.getItem('usuario_telefono') || '',
            numero_cliente: localStorage.getItem('usuario_numero_cliente') || '',
            direccion: localStorage.getItem('usuario_direccion') || '',
            colonia: localStorage.getItem('usuario_colonia') || '',
            horario_entrega: localStorage.getItem('horario_entrega') || '',
            pago: metodoPago,
            info_pago: infoPago,
            pago_efectivo_cambio: localStorage.getItem('pago_efectivo_cambio') || '',
            pago_efectivo_monto: localStorage.getItem('pago_efectivo_monto') || '',
            carrito: carritoLocal,
            total: total,
            ahorro: ahorro
        };

        try {
            const res = await fetch('/api/confirmacion/recuperar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                location.reload();
                return true;
            }
        } catch (e) {
            console.error('Error recuperando confirmaci√≥n', e);
        }
        return false;
    }

    // Limpiar el carrito del localStorage y del flotante solo cuando ya hay datos
    window.addEventListener('load', async function () {
        const recuperado = await intentarRecuperacion();
        if (recuperado) return;

        const dataElem = document.getElementById('confirmacion-data');
        const hasCarrito = dataElem?.dataset?.hasCarrito === '1';
        if (hasCarrito) {
            localStorage.removeItem('carrito');
            localStorage.setItem('pedido_enviado', '1');
            document.getElementById('carrito-contador')?.textContent = '0';
            document.getElementById('carrito-total')?.textContent = '0.00';
            document.getElementById('carrito')?.style?.display = 'none';
            mostrarToast("Pedido enviado correctamente");
        }
    });

    function mostrarToast(mensaje, color = "#4CAF50", icono = "‚úÖ") {
        const toast = document.getElementById("toast");
        const msg = document.getElementById("toast-message");
        const iconElem = document.getElementById("toast-icon");
        const bar = document.getElementById("toast-progress");

        msg.textContent = mensaje;
        iconElem.textContent = icono;
        toast.style.backgroundColor = color;
        toast.style.display = "block";

        bar.style.transition = "none";
        bar.style.width = "100%";
        void bar.offsetWidth;
        bar.style.transition = "width 5s linear";
        bar.style.width = "0%";

        setTimeout(() => {
            toast.style.display = "none";
        }, 5000);
    }
</script>

<script>
// üõí Cargar y limpiar carrito si se envi√≥ un pedido
let carrito = (() => {
    const flag = localStorage.getItem('pedido_enviado');
    if (flag === '1') {
        localStorage.removeItem('carrito');
        localStorage.removeItem('pedido_enviado');
        return [];
    }
    return JSON.parse(localStorage.getItem('carrito')) || [];
})();

// üîÑ Actualizar contador del carrito en el encabezado
function actualizarBotonCarrito() {
    let total = 0, cantidad = 0;
    carrito.forEach(p => {
        total += p.precio * p.cantidad;
        cantidad += p.cantidad;
    });
    const contador = document.getElementById('carrito-contador');
    const totalSpan = document.getElementById('carrito-total');
    if (contador) contador.textContent = cantidad;
    if (totalSpan) totalSpan.textContent = total.toFixed(2);
}

window.addEventListener('load', actualizarBotonCarrito);
</script>

{% endblock %}
